unit uDmData;

interface

uses
  System.SysUtils, System.Classes, Data.DB, DBAccess, FMX.Platform,
  Uni, UniProvider, PostgreSQLUniProvider, FMX.Notification;

type
  TDmData = class(TDataModule)
    uD_pgProv: TPostgreSQLUniProvider;
    uDconn_pg: TUniConnection;
    ncPush: TNotificationCenter;

    procedure DataModuleCreate(Sender: TObject);
    procedure altMaturity;
    procedure ncPushReceiveLocalNotification(Sender: TObject;
      ANotification: TNotification);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  DmData: TDmData;
  ItemControl: String;
  Nitems: Integer;

implementation

{%CLASSGROUP 'FMX.Controls.TControl'}

uses uItem;

{$R *.dfm}

procedure TDmData.altMaturity;
var
 uDqrMaturity: TUniQuery;
 Ntf: TNotification;
begin
 try
 uDqrMaturity := TUniQuery.Create(nil);
 uDqrMaturity.Connection := uDconn_pg;

 uDqrMaturity.SQL.Text := ' SELECT id, dt_fim'+
                          ' FROM'+
                          ' public.lista_comp';
 uDqrMaturity.Open;
 uDqrMaturity.First;

  while not uDqrMaturity.Eof do
  begin
   if ((uDqrMaturity.Fields[1].AsDateTime - Now) <= 3) then
   begin
    Ntf := ncPush.CreateNotification;
    Ntf.AlertBody := 'Os itens da lista de código '
                     +uDqrMaturity.Fields[0].AsString+
                     ' podem estar acabando.'+sLineBreak+
                     ' Lembre-se deles na próxima ida ao mercado!';
    Ntf.Number := 1;
    Ntf.EnableSound := True;
    ncPush.PresentNotification(Ntf);
   end;
   uDqrMaturity.Next;
  end;

 finally
 uDqrMaturity.Free;
 end;
end;

procedure TDmData.DataModuleCreate(Sender: TObject);
{
var
  uDqryUtis: TUniQuery;
  CurDate: String;
}
begin
{
  // Pega data corrente
  CurDate := FormatDateTime('YYYY/MM/DD', Date);

  // Cria query
  uDqryUtis := TUniQuery.Create(nil);
  uDqryUtis.Connection := uDconn_pg;

  // Exclui listas vencidas
  uDqryUtis.SQL.Text := ' DELETE FROM public.lista_comp'+
                        ' WHERE dt_fim ='+QuotedStr(CurDate);
  uDqryUtis.ExecSQL;
}
end;

procedure TDmData.ncPushReceiveLocalNotification(Sender: TObject;
  ANotification: TNotification);
begin
  // Chama tela de detalhes da lista
  FrmItem := TFrmItem.Create(self);
  FrmItem.Show;
end;

end.
